<!DOCTYPE html>
<html>
<head>
    <title>Monitor Systemu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .kpi-card { border-left: 5px solid #0d6efd; }
        .kpi-card.danger { border-left-color: #dc3545; }

        /* --- POPRAWKI LAYOUTU --- */

        /* Lewa kolumna (Procesy): Sztywna wysoko≈õƒá, ≈ºeby zawsze wype≈Çnia≈Ça kartƒô */
        .process-list-container {
            height: 600px;       /* Ustalona wysoko≈õƒá */
            overflow-y: auto;    /* Pasek przewijania */
        }

        /* Prawa kolumna (Blokady): Ograniczenie wysoko≈õci, ≈ºeby nie rozciƒÖga≈Ça strony */
        .blocked-list-container {
            max-height: 350px;   /* Maksymalna wysoko≈õƒá */
            overflow-y: auto;    /* Pasek przewijania */
        }

        /* ≈Åadniejszy czas w logach */
        .time-badge { font-family: monospace; font-size: 1.1em; color: #dc3545; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">üõ°Ô∏è System Monitor</a>
        <div class="ms-auto">
            {% if session.get('logged_in') %}
                <span class="badge bg-danger me-3">ADMINISTRATOR</span>
                <a href="/settings" class="btn btn-primary btn-sm me-2">‚öôÔ∏è Ustawienia</a>
                <a href="/logout" class="btn btn-outline-light btn-sm">Wyloguj</a>
            {% else %}
                <a href="/login" class="btn btn-outline-light btn-sm">üîí Zaloguj</a>
            {% endif %}
        </div>
    </div>
</nav>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm kpi-card">
                <div class="card-body">
                    <h5 class="card-title text-muted text-uppercase small fw-bold">Ca≈Çkowity Czas Pracy</h5>
                    <h3>{{ total_hours }} <small class="text-muted fs-6">godzin</small></h3>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm kpi-card danger">
                <div class="card-body">
                    <h5 class="card-title text-muted text-uppercase small fw-bold">Blokady Dzisiaj</h5>
                    <h3 class="text-danger">{{ blocks_today }} <small class="text-muted fs-6">pr√≥b</small></h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold">Aktywno≈õƒá w ciƒÖgu doby</div>
                <div class="card-body">
                    <canvas id="hourlyChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-danger text-white fw-bold">Najczƒô≈õciej Blokowane</div>
                <div class="card-body">
                    <canvas id="blockedChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Aktywne Procesy</span>
                    <div class="d-flex">
                        <input type="text" id="searchInput" class="form-control form-control-sm me-2" placeholder="Szukaj..." style="width: 150px;">
                        <a href="/" class="btn btn-sm btn-outline-primary">Od≈õwie≈º üîÑ</a>
                    </div>
                </div>

                <div class="card-body p-0 process-list-container">
                    <table class="table table-striped table-hover mb-0 align-middle" id="procTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Nazwa</th>
                                <th>RAM</th>
                                <th>CPU</th>
                                <th class="text-end">Akcja</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proc in live %}
                            <tr>
                                <td class="fw-bold text-truncate" style="max-width: 200px;">{{ proc['name'] }}</td>
                                <td><span class="badge bg-light text-dark border">{{ proc['mem'] }} MB</span></td>
                                <td>
                                    {% if proc['cpu'] > 10 %}
                                        <span class="fw-bold text-danger">{{ proc['cpu'] }}%</span>
                                    {% else %}
                                        <span class="text-muted">{{ proc['cpu'] }}%</span>
                                    {% endif %}
                                </td>

                                <td class="text-end">
                                    {% if session.get('logged_in') %}
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="confirmKill('{{ proc['name'] }}')">
                                            Zabij
                                        </button>
                                    {% else %}
                                        <span class="text-muted small">üîí</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center p-3">Brak danych.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header fw-bold">Top 5 Czasoch≈Çonnych</div>
                <div class="card-body">
                    <canvas id="usageChart" height="200"></canvas>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white fw-bold">‚õî Ostatnie Blokady</div>

                <div class="blocked-list-container">
                    <ul class="list-group list-group-flush">
                        {% for item in blocked %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-truncate" style="max-width: 180px;">{{ item['process_name'] }}</span>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    {{ item['reason'] if item['reason'] else 'Blacklist' }}
                                </small>
                            </div>

                            <div class="text-end">
                                <div class="fw-bold text-dark font-monospace">
                                    {{ item['added_at'].split(' ')[1] }}
                                </div>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    {{ item['added_at'].split(' ')[0] }}
                                </small>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-5 pb-5"></div>

</div>

<div class="modal fade" id="killModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Potwierdzenie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Czy na pewno chcesz si≈Çowo zamknƒÖƒá proces: <strong id="modalProcName"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <form action="/kill_process" method="POST" style="display:inline;">
                    <input type="hidden" name="target_name" id="killInput">
                    <button type="submit" class="btn btn-danger">Tak, zabij proces</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Wykresy
    new Chart(document.getElementById('usageChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: {{ labels | tojson }},
            datasets: [{
                data: {{ data | tojson }},
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
            }]
        },
        options: { maintainAspectRatio: false }
    });

    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: {{ hourly_labels | tojson }},
            datasets: [{
                label: 'Liczba uruchomie≈Ñ',
                data: {{ hourly_data | tojson }},
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    new Chart(document.getElementById('blockedChart'), {
        type: 'pie',
        data: {
            labels: {{ top_blocked_labels | tojson }},
            datasets: [{
                data: {{ top_blocked_data | tojson }},
                backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#6c757d', '#20c997']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Modal
    function confirmKill(procName) {
        document.getElementById('modalProcName').innerText = procName;
        document.getElementById('killInput').value = procName;
        new bootstrap.Modal(document.getElementById('killModal')).show();
    }

    // Wyszukiwarka Live
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('#procTable tbody tr');
        rows.forEach(row => {
            let text = row.cells[0].textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });
</script>

</body>
</html>